/**
 * ownCloud - Compress plugin
 *
 * @author Xavier Beurois
 * @copyright 2012 Xavier Beurois www.djazz-lab.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU AFFERO GENERAL PUBLIC LICENSE for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Minified with http://fmarcia.info/jsmin/test.html
 *
 */

$(document).ready(function() {
	if ( typeof FileActions !== 'undefined') {
		FileActions.register('all', t('compress', 'Compress'), OC.imagePath('compress', 'compress.png'), function(d) {
			if ($('#dropdown').length > 0) {
				$('#dropdown').hide('blind', function() {
					var df = $('#dropdown').data('file');
					var f = $('#dir').val() + '/' + d;
					$('#dropdown').remove();
					$('tr').removeClass('mouseOver');
					if (df != f) {
						ddCompress(d, f);
					}
				});
			} else {
				ddCompress(d, $('#dir').val() + '/' + d);
			}
		}, 8, true);
	}
});

function ddCompress(f, fs) {
	var html = '<div id="dropdown" class="drop" data-file="' + fs + '"><div id="ddcselect"><select data-placeholder="Algorithm" style="width:205px;" id="compress_sel" class="chzen-select"></select></div><div id="submit_ca"><input type="button" id="s_ca" value="' + t('compress', 'Enter') + '" /></div>';
	if (f) {
		$('tr').filterAttr('data-file', f).addClass('mouseOver');
		$(html).appendTo($('tr').filterAttr('data-file', f).find('td.filename'));
	}
	$.getJSON(OC.linkTo('compress', 'ajax/getalgos.php'), function(a) {
		$.each(a, function(k, v) {
			$(v).appendTo('#compress_sel');
		});
		$('#compress_sel').trigger('liszt:updated');
	});
	$('#dropdown').show('blind');
	$('#compress_sel').chosen();
	$('#s_ca').bind('click', function() {
		$('#submit_ca').html('<img src="' + OC.imagePath('compress', 'loader.gif') + '" /><span style="margin-left:5px;">' + t('compress', 'Compressing') + '</span>');
		$.ajax({
			type : 'POST',
			url : OC.linkTo('compress', 'ajax/compress.php'),
			dataType : 'json',
			data : {
				a : $('#compress_sel').val(),
				f : $('#dir').val() + '/' + f
			},
			async : false,
			success : function(k) {
				document.location.reload();
			}
		});
	});
}